#!/usr/bin/env python
from ase import Atoms
from ase.calculators.espresso import Espresso, EspressoProfile
from ase.io import write
import os
import numpy as np
import subprocess
import shutil
import sys
sys.stdout.flush()  

# ==============================================
# ASE Band Structure Calculation
# ==============================================
#
# ==============================================
# 1. Quantum Espresso Input Parameters
# ==============================================
pseudopotentials = {
    'C': 'C.upf'
}

base_input_data = {
    'control': {
        'prefix': 'graphene',
        'outdir': './tmp',
        'verbosity': 'low',
        'tstress': True,
        'tprnfor': True,
        'wf_collect': True,
        'disk_io': 'high'
    },
    'system': {
        'ecutwfc': 100,
        'occupations': 'smearing',
        'smearing': 'gauss',
        'degauss': 0.01,
        'ibrav': 0,
        'nat': 2,
        'ntyp': 1,
        'assume_isolated': '2D'
    },
    'electrons': {
        'conv_thr': 1.0e-10
    }
}

# ==============================================
# 2. Atomic Structure (from seekpath)
#    https://seekpath.materialscloud.io/
# ==============================================
prim_atoms = Atoms(
    symbols=['C']*2,
    positions=[ # positions in Angstrom
        [1.2331607548, 0.7119656938, 7.5000000000],
        [0.0000000000, 1.4239313875, 7.5000000000]
    ],
    cell=[ # positions in Angstrom
        [2.4663215097, 0.0000000000, 0.0000000000],
        [-1.2331607548, 2.1358970813, 0.0000000000],
        [0.0000000000, 0.0000000000, 15.0000000000]
    ],
    pbc=[True, True, True]
)

# ==============================================
# 3. K-point path for band structure calculation (from seekpath)
#    Labels of highly symmetric points are to be taken from seekpath
#    Copy the highly symmetric points list under "Quantum ESPRESSO pw.x input" in file 'kp'
#    Then use the following command to format it in ASE format
#    awk '{printf("    [%s, %s, %s, %s],\n", $1, $2, $3, $4)}' kp > kp_parsed
#    Then paste the formated output below
# ==============================================
kpts_crystal = np.array([
    [0.0000000000, 0.0000000000, 0.0000000000, 1],
    [0.0087719298, 0.0000000000, 0.0000000000, 1],
    [0.0175438596, 0.0000000000, 0.0000000000, 1],
    [0.0263157895, 0.0000000000, 0.0000000000, 1],
    [0.0350877193, 0.0000000000, 0.0000000000, 1],
    [0.0438596491, 0.0000000000, 0.0000000000, 1],
    [0.0526315789, 0.0000000000, 0.0000000000, 1],
    [0.0614035088, 0.0000000000, 0.0000000000, 1],
    [0.0701754386, 0.0000000000, 0.0000000000, 1],
    [0.0789473684, 0.0000000000, 0.0000000000, 1],
    [0.0877192982, 0.0000000000, 0.0000000000, 1],
    [0.0964912281, 0.0000000000, 0.0000000000, 1],
    [0.1052631579, 0.0000000000, 0.0000000000, 1],
    [0.1140350877, 0.0000000000, 0.0000000000, 1],
    [0.1228070175, 0.0000000000, 0.0000000000, 1],
    [0.1315789474, 0.0000000000, 0.0000000000, 1],
    [0.1403508772, 0.0000000000, 0.0000000000, 1],
    [0.1491228070, 0.0000000000, 0.0000000000, 1],
    [0.1578947368, 0.0000000000, 0.0000000000, 1],
    [0.1666666667, 0.0000000000, 0.0000000000, 1],
    [0.1754385965, 0.0000000000, 0.0000000000, 1],
    [0.1842105263, 0.0000000000, 0.0000000000, 1],
    [0.1929824561, 0.0000000000, 0.0000000000, 1],
    [0.2017543860, 0.0000000000, 0.0000000000, 1],
    [0.2105263158, 0.0000000000, 0.0000000000, 1],
    [0.2192982456, 0.0000000000, 0.0000000000, 1],
    [0.2280701754, 0.0000000000, 0.0000000000, 1],
    [0.2368421053, 0.0000000000, 0.0000000000, 1],
    [0.2456140351, 0.0000000000, 0.0000000000, 1],
    [0.2543859649, 0.0000000000, 0.0000000000, 1],
    [0.2631578947, 0.0000000000, 0.0000000000, 1],
    [0.2719298246, 0.0000000000, 0.0000000000, 1],
    [0.2807017544, 0.0000000000, 0.0000000000, 1],
    [0.2894736842, 0.0000000000, 0.0000000000, 1],
    [0.2982456140, 0.0000000000, 0.0000000000, 1],
    [0.3070175439, 0.0000000000, 0.0000000000, 1],
    [0.3157894737, 0.0000000000, 0.0000000000, 1],
    [0.3245614035, 0.0000000000, 0.0000000000, 1],
    [0.3333333333, 0.0000000000, 0.0000000000, 1],
    [0.3421052632, 0.0000000000, 0.0000000000, 1],
    [0.3508771930, 0.0000000000, 0.0000000000, 1],
    [0.3596491228, 0.0000000000, 0.0000000000, 1],
    [0.3684210526, 0.0000000000, 0.0000000000, 1],
    [0.3771929825, 0.0000000000, 0.0000000000, 1],
    [0.3859649123, 0.0000000000, 0.0000000000, 1],
    [0.3947368421, 0.0000000000, 0.0000000000, 1],
    [0.4035087719, 0.0000000000, 0.0000000000, 1],
    [0.4122807018, 0.0000000000, 0.0000000000, 1],
    [0.4210526316, 0.0000000000, 0.0000000000, 1],
    [0.4298245614, 0.0000000000, 0.0000000000, 1],
    [0.4385964912, 0.0000000000, 0.0000000000, 1],
    [0.4473684211, 0.0000000000, 0.0000000000, 1],
    [0.4561403509, 0.0000000000, 0.0000000000, 1],
    [0.4649122807, 0.0000000000, 0.0000000000, 1],
    [0.4736842105, 0.0000000000, 0.0000000000, 1],
    [0.4824561404, 0.0000000000, 0.0000000000, 1],
    [0.4912280702, 0.0000000000, 0.0000000000, 1],
    [0.5000000000, 0.0000000000, 0.0000000000, 1],
    [0.4947916667, 0.0104166667, 0.0000000000, 1],
    [0.4895833333, 0.0208333333, 0.0000000000, 1],
    [0.4843750000, 0.0312500000, 0.0000000000, 1],
    [0.4791666667, 0.0416666667, 0.0000000000, 1],
    [0.4739583333, 0.0520833333, 0.0000000000, 1],
    [0.4687500000, 0.0625000000, 0.0000000000, 1],
    [0.4635416667, 0.0729166667, 0.0000000000, 1],
    [0.4583333333, 0.0833333333, 0.0000000000, 1],
    [0.4531250000, 0.0937500000, 0.0000000000, 1],
    [0.4479166667, 0.1041666667, 0.0000000000, 1],
    [0.4427083333, 0.1145833333, 0.0000000000, 1],
    [0.4375000000, 0.1250000000, 0.0000000000, 1],
    [0.4322916667, 0.1354166667, 0.0000000000, 1],
    [0.4270833333, 0.1458333333, 0.0000000000, 1],
    [0.4218750000, 0.1562500000, 0.0000000000, 1],
    [0.4166666667, 0.1666666667, 0.0000000000, 1],
    [0.4114583333, 0.1770833333, 0.0000000000, 1],
    [0.4062500000, 0.1875000000, 0.0000000000, 1],
    [0.4010416667, 0.1979166667, 0.0000000000, 1],
    [0.3958333333, 0.2083333333, 0.0000000000, 1],
    [0.3906250000, 0.2187500000, 0.0000000000, 1],
    [0.3854166667, 0.2291666667, 0.0000000000, 1],
    [0.3802083333, 0.2395833333, 0.0000000000, 1],
    [0.3750000000, 0.2500000000, 0.0000000000, 1],
    [0.3697916667, 0.2604166667, 0.0000000000, 1],
    [0.3645833333, 0.2708333333, 0.0000000000, 1],
    [0.3593750000, 0.2812500000, 0.0000000000, 1],
    [0.3541666667, 0.2916666667, 0.0000000000, 1],
    [0.3489583333, 0.3020833333, 0.0000000000, 1],
    [0.3437500000, 0.3125000000, 0.0000000000, 1],
    [0.3385416667, 0.3229166667, 0.0000000000, 1],
    [0.3333333333, 0.3333333333, 0.0000000000, 1],
    [0.3282828283, 0.3282828283, 0.0000000000, 1],
    [0.3232323232, 0.3232323232, 0.0000000000, 1],
    [0.3181818182, 0.3181818182, 0.0000000000, 1],
    [0.3131313131, 0.3131313131, 0.0000000000, 1],
    [0.3080808081, 0.3080808081, 0.0000000000, 1],
    [0.3030303030, 0.3030303030, 0.0000000000, 1],
    [0.2979797980, 0.2979797980, 0.0000000000, 1],
    [0.2929292929, 0.2929292929, 0.0000000000, 1],
    [0.2878787879, 0.2878787879, 0.0000000000, 1],
    [0.2828282828, 0.2828282828, 0.0000000000, 1],
    [0.2777777778, 0.2777777778, 0.0000000000, 1],
    [0.2727272727, 0.2727272727, 0.0000000000, 1],
    [0.2676767677, 0.2676767677, 0.0000000000, 1],
    [0.2626262626, 0.2626262626, 0.0000000000, 1],
    [0.2575757576, 0.2575757576, 0.0000000000, 1],
    [0.2525252525, 0.2525252525, 0.0000000000, 1],
    [0.2474747475, 0.2474747475, 0.0000000000, 1],
    [0.2424242424, 0.2424242424, 0.0000000000, 1],
    [0.2373737374, 0.2373737374, 0.0000000000, 1],
    [0.2323232323, 0.2323232323, 0.0000000000, 1],
    [0.2272727273, 0.2272727273, 0.0000000000, 1],
    [0.2222222222, 0.2222222222, 0.0000000000, 1],
    [0.2171717172, 0.2171717172, 0.0000000000, 1],
    [0.2121212121, 0.2121212121, 0.0000000000, 1],
    [0.2070707071, 0.2070707071, 0.0000000000, 1],
    [0.2020202020, 0.2020202020, 0.0000000000, 1],
    [0.1969696970, 0.1969696970, 0.0000000000, 1],
    [0.1919191919, 0.1919191919, 0.0000000000, 1],
    [0.1868686869, 0.1868686869, 0.0000000000, 1],
    [0.1818181818, 0.1818181818, 0.0000000000, 1],
    [0.1767676768, 0.1767676768, 0.0000000000, 1],
    [0.1717171717, 0.1717171717, 0.0000000000, 1],
    [0.1666666667, 0.1666666667, 0.0000000000, 1],
    [0.1616161616, 0.1616161616, 0.0000000000, 1],
    [0.1565656566, 0.1565656566, 0.0000000000, 1],
    [0.1515151515, 0.1515151515, 0.0000000000, 1],
    [0.1464646465, 0.1464646465, 0.0000000000, 1],
    [0.1414141414, 0.1414141414, 0.0000000000, 1],
    [0.1363636364, 0.1363636364, 0.0000000000, 1],
    [0.1313131313, 0.1313131313, 0.0000000000, 1],
    [0.1262626263, 0.1262626263, 0.0000000000, 1],
    [0.1212121212, 0.1212121212, 0.0000000000, 1],
    [0.1161616162, 0.1161616162, 0.0000000000, 1],
    [0.1111111111, 0.1111111111, 0.0000000000, 1],
    [0.1060606061, 0.1060606061, 0.0000000000, 1],
    [0.1010101010, 0.1010101010, 0.0000000000, 1],
    [0.0959595960, 0.0959595960, 0.0000000000, 1],
    [0.0909090909, 0.0909090909, 0.0000000000, 1],
    [0.0858585859, 0.0858585859, 0.0000000000, 1],
    [0.0808080808, 0.0808080808, 0.0000000000, 1],
    [0.0757575758, 0.0757575758, 0.0000000000, 1],
    [0.0707070707, 0.0707070707, 0.0000000000, 1],
    [0.0656565657, 0.0656565657, 0.0000000000, 1],
    [0.0606060606, 0.0606060606, 0.0000000000, 1],
    [0.0555555556, 0.0555555556, 0.0000000000, 1],
    [0.0505050505, 0.0505050505, 0.0000000000, 1],
    [0.0454545455, 0.0454545455, 0.0000000000, 1],
    [0.0404040404, 0.0404040404, 0.0000000000, 1],
    [0.0353535354, 0.0353535354, 0.0000000000, 1],
    [0.0303030303, 0.0303030303, 0.0000000000, 1],
    [0.0252525253, 0.0252525253, 0.0000000000, 1],
    [0.0202020202, 0.0202020202, 0.0000000000, 1],
    [0.0151515152, 0.0151515152, 0.0000000000, 1],
    [0.0101010101, 0.0101010101, 0.0000000000, 1],
    [0.0050505051, 0.0050505051, 0.0000000000, 1],
    [0.0000000000, 0.0000000000, 0.0000000000, 1],
    [0.0000000000, 0.0000000000, 0.0714285714, 1],
    [0.0000000000, 0.0000000000, 0.1428571429, 1],
    [0.0000000000, 0.0000000000, 0.2142857143, 1],
    [0.0000000000, 0.0000000000, 0.2857142857, 1],
    [0.0000000000, 0.0000000000, 0.3571428571, 1],
    [0.0000000000, 0.0000000000, 0.4285714286, 1],
    [0.0000000000, 0.0000000000, 0.5000000000, 1],
    [0.0087719298, 0.0000000000, 0.5000000000, 1],
    [0.0175438596, 0.0000000000, 0.5000000000, 1],
    [0.0263157895, 0.0000000000, 0.5000000000, 1],
    [0.0350877193, 0.0000000000, 0.5000000000, 1],
    [0.0438596491, 0.0000000000, 0.5000000000, 1],
    [0.0526315789, 0.0000000000, 0.5000000000, 1],
    [0.0614035088, 0.0000000000, 0.5000000000, 1],
    [0.0701754386, 0.0000000000, 0.5000000000, 1],
    [0.0789473684, 0.0000000000, 0.5000000000, 1],
    [0.0877192982, 0.0000000000, 0.5000000000, 1],
    [0.0964912281, 0.0000000000, 0.5000000000, 1],
    [0.1052631579, 0.0000000000, 0.5000000000, 1],
    [0.1140350877, 0.0000000000, 0.5000000000, 1],
    [0.1228070175, 0.0000000000, 0.5000000000, 1],
    [0.1315789474, 0.0000000000, 0.5000000000, 1],
    [0.1403508772, 0.0000000000, 0.5000000000, 1],
    [0.1491228070, 0.0000000000, 0.5000000000, 1],
    [0.1578947368, 0.0000000000, 0.5000000000, 1],
    [0.1666666667, 0.0000000000, 0.5000000000, 1],
    [0.1754385965, 0.0000000000, 0.5000000000, 1],
    [0.1842105263, 0.0000000000, 0.5000000000, 1],
    [0.1929824561, 0.0000000000, 0.5000000000, 1],
    [0.2017543860, 0.0000000000, 0.5000000000, 1],
    [0.2105263158, 0.0000000000, 0.5000000000, 1],
    [0.2192982456, 0.0000000000, 0.5000000000, 1],
    [0.2280701754, 0.0000000000, 0.5000000000, 1],
    [0.2368421053, 0.0000000000, 0.5000000000, 1],
    [0.2456140351, 0.0000000000, 0.5000000000, 1],
    [0.2543859649, 0.0000000000, 0.5000000000, 1],
    [0.2631578947, 0.0000000000, 0.5000000000, 1],
    [0.2719298246, 0.0000000000, 0.5000000000, 1],
    [0.2807017544, 0.0000000000, 0.5000000000, 1],
    [0.2894736842, 0.0000000000, 0.5000000000, 1],
    [0.2982456140, 0.0000000000, 0.5000000000, 1],
    [0.3070175439, 0.0000000000, 0.5000000000, 1],
    [0.3157894737, 0.0000000000, 0.5000000000, 1],
    [0.3245614035, 0.0000000000, 0.5000000000, 1],
    [0.3333333333, 0.0000000000, 0.5000000000, 1],
    [0.3421052632, 0.0000000000, 0.5000000000, 1],
    [0.3508771930, 0.0000000000, 0.5000000000, 1],
    [0.3596491228, 0.0000000000, 0.5000000000, 1],
    [0.3684210526, 0.0000000000, 0.5000000000, 1],
    [0.3771929825, 0.0000000000, 0.5000000000, 1],
    [0.3859649123, 0.0000000000, 0.5000000000, 1],
    [0.3947368421, 0.0000000000, 0.5000000000, 1],
    [0.4035087719, 0.0000000000, 0.5000000000, 1],
    [0.4122807018, 0.0000000000, 0.5000000000, 1],
    [0.4210526316, 0.0000000000, 0.5000000000, 1],
    [0.4298245614, 0.0000000000, 0.5000000000, 1],
    [0.4385964912, 0.0000000000, 0.5000000000, 1],
    [0.4473684211, 0.0000000000, 0.5000000000, 1],
    [0.4561403509, 0.0000000000, 0.5000000000, 1],
    [0.4649122807, 0.0000000000, 0.5000000000, 1],
    [0.4736842105, 0.0000000000, 0.5000000000, 1],
    [0.4824561404, 0.0000000000, 0.5000000000, 1],
    [0.4912280702, 0.0000000000, 0.5000000000, 1],
    [0.5000000000, 0.0000000000, 0.5000000000, 1],
    [0.4947916667, 0.0104166667, 0.5000000000, 1],
    [0.4895833333, 0.0208333333, 0.5000000000, 1],
    [0.4843750000, 0.0312500000, 0.5000000000, 1],
    [0.4791666667, 0.0416666667, 0.5000000000, 1],
    [0.4739583333, 0.0520833333, 0.5000000000, 1],
    [0.4687500000, 0.0625000000, 0.5000000000, 1],
    [0.4635416667, 0.0729166667, 0.5000000000, 1],
    [0.4583333333, 0.0833333333, 0.5000000000, 1],
    [0.4531250000, 0.0937500000, 0.5000000000, 1],
    [0.4479166667, 0.1041666667, 0.5000000000, 1],
    [0.4427083333, 0.1145833333, 0.5000000000, 1],
    [0.4375000000, 0.1250000000, 0.5000000000, 1],
    [0.4322916667, 0.1354166667, 0.5000000000, 1],
    [0.4270833333, 0.1458333333, 0.5000000000, 1],
    [0.4218750000, 0.1562500000, 0.5000000000, 1],
    [0.4166666667, 0.1666666667, 0.5000000000, 1],
    [0.4114583333, 0.1770833333, 0.5000000000, 1],
    [0.4062500000, 0.1875000000, 0.5000000000, 1],
    [0.4010416667, 0.1979166667, 0.5000000000, 1],
    [0.3958333333, 0.2083333333, 0.5000000000, 1],
    [0.3906250000, 0.2187500000, 0.5000000000, 1],
    [0.3854166667, 0.2291666667, 0.5000000000, 1],
    [0.3802083333, 0.2395833333, 0.5000000000, 1],
    [0.3750000000, 0.2500000000, 0.5000000000, 1],
    [0.3697916667, 0.2604166667, 0.5000000000, 1],
    [0.3645833333, 0.2708333333, 0.5000000000, 1],
    [0.3593750000, 0.2812500000, 0.5000000000, 1],
    [0.3541666667, 0.2916666667, 0.5000000000, 1],
    [0.3489583333, 0.3020833333, 0.5000000000, 1],
    [0.3437500000, 0.3125000000, 0.5000000000, 1],
    [0.3385416667, 0.3229166667, 0.5000000000, 1],
    [0.3333333333, 0.3333333333, 0.5000000000, 1],
    [0.3282828283, 0.3282828283, 0.5000000000, 1],
    [0.3232323232, 0.3232323232, 0.5000000000, 1],
    [0.3181818182, 0.3181818182, 0.5000000000, 1],
    [0.3131313131, 0.3131313131, 0.5000000000, 1],
    [0.3080808081, 0.3080808081, 0.5000000000, 1],
    [0.3030303030, 0.3030303030, 0.5000000000, 1],
    [0.2979797980, 0.2979797980, 0.5000000000, 1],
    [0.2929292929, 0.2929292929, 0.5000000000, 1],
    [0.2878787879, 0.2878787879, 0.5000000000, 1],
    [0.2828282828, 0.2828282828, 0.5000000000, 1],
    [0.2777777778, 0.2777777778, 0.5000000000, 1],
    [0.2727272727, 0.2727272727, 0.5000000000, 1],
    [0.2676767677, 0.2676767677, 0.5000000000, 1],
    [0.2626262626, 0.2626262626, 0.5000000000, 1],
    [0.2575757576, 0.2575757576, 0.5000000000, 1],
    [0.2525252525, 0.2525252525, 0.5000000000, 1],
    [0.2474747475, 0.2474747475, 0.5000000000, 1],
    [0.2424242424, 0.2424242424, 0.5000000000, 1],
    [0.2373737374, 0.2373737374, 0.5000000000, 1],
    [0.2323232323, 0.2323232323, 0.5000000000, 1],
    [0.2272727273, 0.2272727273, 0.5000000000, 1],
    [0.2222222222, 0.2222222222, 0.5000000000, 1],
    [0.2171717172, 0.2171717172, 0.5000000000, 1],
    [0.2121212121, 0.2121212121, 0.5000000000, 1],
    [0.2070707071, 0.2070707071, 0.5000000000, 1],
    [0.2020202020, 0.2020202020, 0.5000000000, 1],
    [0.1969696970, 0.1969696970, 0.5000000000, 1],
    [0.1919191919, 0.1919191919, 0.5000000000, 1],
    [0.1868686869, 0.1868686869, 0.5000000000, 1],
    [0.1818181818, 0.1818181818, 0.5000000000, 1],
    [0.1767676768, 0.1767676768, 0.5000000000, 1],
    [0.1717171717, 0.1717171717, 0.5000000000, 1],
    [0.1666666667, 0.1666666667, 0.5000000000, 1],
    [0.1616161616, 0.1616161616, 0.5000000000, 1],
    [0.1565656566, 0.1565656566, 0.5000000000, 1],
    [0.1515151515, 0.1515151515, 0.5000000000, 1],
    [0.1464646465, 0.1464646465, 0.5000000000, 1],
    [0.1414141414, 0.1414141414, 0.5000000000, 1],
    [0.1363636364, 0.1363636364, 0.5000000000, 1],
    [0.1313131313, 0.1313131313, 0.5000000000, 1],
    [0.1262626263, 0.1262626263, 0.5000000000, 1],
    [0.1212121212, 0.1212121212, 0.5000000000, 1],
    [0.1161616162, 0.1161616162, 0.5000000000, 1],
    [0.1111111111, 0.1111111111, 0.5000000000, 1],
    [0.1060606061, 0.1060606061, 0.5000000000, 1],
    [0.1010101010, 0.1010101010, 0.5000000000, 1],
    [0.0959595960, 0.0959595960, 0.5000000000, 1],
    [0.0909090909, 0.0909090909, 0.5000000000, 1],
    [0.0858585859, 0.0858585859, 0.5000000000, 1],
    [0.0808080808, 0.0808080808, 0.5000000000, 1],
    [0.0757575758, 0.0757575758, 0.5000000000, 1],
    [0.0707070707, 0.0707070707, 0.5000000000, 1],
    [0.0656565657, 0.0656565657, 0.5000000000, 1],
    [0.0606060606, 0.0606060606, 0.5000000000, 1],
    [0.0555555556, 0.0555555556, 0.5000000000, 1],
    [0.0505050505, 0.0505050505, 0.5000000000, 1],
    [0.0454545455, 0.0454545455, 0.5000000000, 1],
    [0.0404040404, 0.0404040404, 0.5000000000, 1],
    [0.0353535354, 0.0353535354, 0.5000000000, 1],
    [0.0303030303, 0.0303030303, 0.5000000000, 1],
    [0.0252525253, 0.0252525253, 0.5000000000, 1],
    [0.0202020202, 0.0202020202, 0.5000000000, 1],
    [0.0151515152, 0.0151515152, 0.5000000000, 1],
    [0.0101010101, 0.0101010101, 0.5000000000, 1],
    [0.0050505051, 0.0050505051, 0.5000000000, 1],
    [0.0000000000, 0.0000000000, 0.5000000000, 1],
    [0.5000000000, 0.0000000000, 0.5000000000, 1],
    [0.5000000000, 0.0000000000, 0.4285714286, 1],
    [0.5000000000, 0.0000000000, 0.3571428571, 1],
    [0.5000000000, 0.0000000000, 0.2857142857, 1],
    [0.5000000000, 0.0000000000, 0.2142857143, 1],
    [0.5000000000, 0.0000000000, 0.1428571429, 1],
    [0.5000000000, 0.0000000000, 0.0714285714, 1],
    [0.5000000000, 0.0000000000, 0.0000000000, 1],
    [0.3333333333, 0.3333333333, 0.5000000000, 1],
    [0.3333333333, 0.3333333333, 0.4285714286, 1],
    [0.3333333333, 0.3333333333, 0.3571428571, 1],
    [0.3333333333, 0.3333333333, 0.2857142857, 1],
    [0.3333333333, 0.3333333333, 0.2142857143, 1],
    [0.3333333333, 0.3333333333, 0.1428571429, 1],
    [0.3333333333, 0.3333333333, 0.0714285714, 1],
    [0.3333333333, 0.3333333333, 0.0000000000, 1]
])

# ==============================================
# 4. Calculator Configuration
# ==============================================
# Set QE bin directory
#qe_bin = "/home/dsen/work/bin/qe-7.4.1_serial"
qe_bin = "/usr/bin"

# Main QE calculation 
#pw_command = f'{qe_bin}/bin/pw.x'
pw_command = f'mpirun -np 8 {qe_bin}/pw.x'

# Serial post-processing commands for fast execution
bands_command = f"{qe_bin}/bands.x < bands.in > bands.out 2>&1"
plotband_command = f"{qe_bin}/plotband.x < plotband.in > plotband.out 2>&1"

profile = EspressoProfile(
    command=pw_command,
    pseudo_dir='./'
)

# Set k-grids (modify as needed)
scf_kpts = (42,42,1)

# Bands energy parameters
energy_range = -18, 8
tick = 2  

# QE tool executation format
def run_qe_tool(command, input_file, tool_name):
    """Run QE tool with input file and redirect output to file"""
    try:
        with open(input_file, 'r') as fin:
            subprocess.run(command, shell=True, stdin=fin, check=True)
        print(f"  {tool_name} completed successfully", flush=True)
        return True
    except subprocess.CalledProcessError as e:
        print(f"Error running {tool_name}: {e}", flush=True)
        return False

# ==============================================
# 5. SCF Calculation 
# ==============================================
print("\n[Phase A] Running SCF calculation...", flush=True)
scf_input_data = base_input_data.copy()
scf_input_data['control']['calculation'] = 'scf'

scf_calc = Espresso(
    profile=profile,
    pseudopotentials=pseudopotentials,
    input_data=scf_input_data,
    kpts=scf_kpts  
)
prim_atoms.calc = scf_calc
total_energy = prim_atoms.get_potential_energy()
fermi_energy = scf_calc.get_fermi_level()
print(f"  SCF completed. Total energy: {total_energy:.6f} eV", flush=True)
print(f"  Fermi energy from SCF: {fermi_energy:.6f} eV", flush=True)

# ==============================================
# 6. Clean up SCF files and prepare for NSCF
# ==============================================
print("\nCleaning up SCF files and preparing for band structure calculation...", flush=True)
os.makedirs('scf_files', exist_ok=True)

# Move ALL SCF-related files
for fname in os.listdir('.'):
    if (fname.startswith('Si_BandStructure.') or 
       fname in ['espresso.pwi', 'espresso.pwo']):
        shutil.move(fname, os.path.join('scf_files', fname))

print("  Moved all SCF-related files to scf_files directory", flush=True)

# ==============================================
# 7. NSCF (bands) Calculation
# ==============================================
print("\n[Phase B] Running NSCF (bands) calculation...", flush=True)
nscf_input_data = base_input_data.copy()
nscf_input_data['control']['calculation'] = 'bands'
nscf_input_data['control'].pop('tstress', None)
nscf_input_data['control'].pop('tprnfor', None)

nscf_calc = Espresso(
    profile=profile,
    pseudopotentials=pseudopotentials,
    input_data=nscf_input_data,
    kpts=kpts_crystal,
    kspacing=None
)

# Direct NSCF execution
nscf_calc.calculate(atoms=prim_atoms,
                   properties=[],
                   system_changes=['positions', 'cell', 'numbers', 'pbc'])
print("  NSCF (bands) calculation completed", flush=True)

# ==============================================
# 8. Extract bands
# ==============================================
print("  Calculating band structure from NSCF", flush=True)
with open('bands.in', 'w') as f:
    f.write(f"""&BANDS
    prefix = '{base_input_data['control']['prefix']}',
    outdir = '{base_input_data['control']['outdir']}',
    filband = 'bands.dat',
/
""")
run_qe_tool(bands_command, 'bands.in', 'bands.x')

# ==============================================
# 9. Plot bands
# ==============================================
print("  Plotting bands", flush=True)
with open('plotband.in', 'w') as f:
    f.write(f"""bands.dat
{energy_range[0]} {energy_range[1]}
bands.gnu
bands.ps
{fermi_energy}
{tick}, {fermi_energy} 
""")
run_qe_tool(plotband_command, 'plotband.in', 'plotband.x')

#if ghostscript installed, convert postscript to image directly. Otherwise disable this.
print("  Exporting plot as jpg image", flush=True)
os.system("gs -sDEVICE=jpeg -dJPEGQ=95 -r600 -sOutputFile=bands.jpg < bands.ps > gs.out")

print("\n=== Band Structure Calculation Complete ===", flush=True)
print("Generated files:", flush=True)
print(f"- SCF results: scf_files/", flush=True)
print(f"- Band structure data: bands.dat", flush=True)
print(f"- Band structure plot: bands.dat.gnu, bands.jpg", flush=True)
