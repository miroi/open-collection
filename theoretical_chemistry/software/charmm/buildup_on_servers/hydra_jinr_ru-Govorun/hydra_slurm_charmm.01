#!/bin/bash

#SBATCH -J CHARMM

##  partition (queue)
##SBATCH -p cascade
##SBATCH -p flnr-ice
#SBATCH -p flnr-sod
##SBATCH -p knl


## max. execution time
##SBATCH -t 7-00:00:00
#SBATCH -t 0-08:00:00

#SBATCH --mem=32GB

# do not restart in the case of nodefail!
#SBATCH --no-requeue
#SBATCH --no-kill

#SBATCH -N 1 -n 4
#SBATCH  --sockets-per-node=1

#SBATCH -o log_slurm_job.%j.%N.std_out

echo Job user is $SLURM_JOB_USER and his job $SLURM_JOB_NAME has assigned ID $SLURM_JOBID
echo This job was submitted from the computer $SLURM_SUBMIT_HOST
echo and from the home directory:
echo $SLURM_SUBMIT_DIR
echo
echo It is running on the cluster compute node:
echo $SLURM_CLUSTER_NAME
echo and is employing $SLURM_JOB_NUM_NODES node/nodes:
echo $SLURM_JOB_NODELIST
echo
echo -e "Job partition is $SLURM_JOB_PARTITION \n"
echo The job requests $SLURM_CPUS_ON_NODE CPU per task.

#echo "modules at disposal:"
#module avail
#echo

#
module purge
#module load openmpi/v2.1.2-2
module add GVR/v1.0-1
module add Python/v3.10.13
#module add intel/oneapi
#module add ELPA/v2025.01.002_oneapi
module add CMake/v3.29.2
module add openmpi/v5.0.7_gcc1230 
module add LAPACK/v3.12.0_gcc1230
module add ScaLAPACK/v2.2.2_openmpi507
module add fftw/v3.3.10_gcc1120

echo -e "\n\n loaded modules:"
module list
#ulimit -s unlimited

echo -e "\n Python ? \c"; which Python; Python -V
echo -e "\n CMake ? \c"; which cmake; cmake --version
echo -e "\n pkg-config ? \c"; which pkg-config; pkg-config --version
echo -e "\n gfortran ? \c"; which gfortran; gfortran --version
echo -e "\n gcc ? \c"; which gcc; gcc --version
echo -e "\n mpif90 ? \c"; which mpif90; mpif90 --version
echo -e "\n mpirun ? \c"; which mpirun; mpirun --version

# readline-devel lib
#echo -e "\n readline-devel library ? \c"; rpm -q readline-devel
#find /usr/lib64 -name 'libreadline.so*'; find /usr/include -name readline.h

CHARMM_DIR=/zfs/scratch/HybriLITWorkshop2025/milias/software/charmm/c50b1
CHARMM=$CHARMM_DIR/charmm_c50b1

INSTALLED_CHARMM=installed_charmm_c50b1_openmpi_lapack
INSTALL_DIR=$CHARMM_DIR/$INSTALLED_CHARMM


cd $CHARMM_DIR
echo -e "\nI am in the directory CHARMM_DIR=$CHARMM_DIR; verify via pwd=";pwd

if [ -d "$INSTALLED_CHARMM" ]; then
  echo -e "\nPREVIOUS directory '$INSTALLED_CHARMM' exists. Removing it.After recreating it again by mkdir."
  rm -rf $INSTALLED_CHARMM
  mkdir $INSTALLED_CHARMM
else
  echo -e "\nPREVIOUS directory '$INSTALLED_CHARMM' does not exist - will be created by mkdir."
  mkdir $INSTALLED_CHARMM
fi
echo -e "Checking presence of install dir, ls -lt $INSTALLED_CHARMM :"; ls -lt $INSTALLED_CHARMM

#
#
#
cd $CHARMM
echo -e "\nI am in the directory CHARMM=$CHARMM; verify via pwd= ";pwd

echo -e "\n\n verify configure : "
./configure --help

echo -e "\n\n launching ./configure ...  command : "
./configure --prefix=$INSTALL_DIR

echo -e "\n\n Going to run make: "
make -C build/cmake install

#echo -e "\n\n Going to run ctest: "
#ctest -VV

#echo -e "\n\n Check of content of the INSTALL_DIR=$INSTALL_DIR :"
#ls -lt $INSTALL_DIR
#ls -lt $INSTALL_DIR/bin
#echo -e "\n\n ldd $INSTALL_DIR/bin/siesta  :"
#ldd $INSTALL_DIR/bin/siesta

exit
