#!/bin/bash

#SBATCH -J SIESTA

##  partition (queue)
##SBATCH -p cascade
##SBATCH -p flnr-ice
#SBATCH -p flnr-sod
##SBATCH -p knl


## max. execution time
##SBATCH -t 7-00:00:00
#SBATCH -t 0-04:00:00

#SBATCH --mem=32GB

# do not restart in the case of nodefail!
#SBATCH --no-requeue
#SBATCH --no-kill

#SBATCH -N 1 -n 4
#SBATCH  --sockets-per-node=1

#SBATCH -o log_slurm_job.%j.%N.std_out

echo Job user is $SLURM_JOB_USER and his job $SLURM_JOB_NAME has assigned ID $SLURM_JOBID
echo This job was submitted from the computer $SLURM_SUBMIT_HOST
echo and from the home directory:
echo $SLURM_SUBMIT_DIR
echo
echo It is running on the cluster compute node:
echo $SLURM_CLUSTER_NAME
echo and is employing $SLURM_JOB_NUM_NODES node/nodes:
echo $SLURM_JOB_NODELIST
echo
echo -e "Job partition is $SLURM_JOB_PARTITION \n"
echo The job requests $SLURM_CPUS_ON_NODE CPU per task.

#echo "modules at disposal:"
#module avail
#echo

#
module purge
#module load openmpi/v2.1.2-2
module add GVR/v1.0-1
module add Python/v3.10.13
module add intel/oneapi
module add ELPA/v2025.01.002_oneapi
module add CMake/v3.29.2

echo -e "\n\n loaded modules:"
module list
#ulimit -s unlimited

echo -e "\n Python ? \c"; which Python; Python -V
echo -e "\n CMake ? \c"; which cmake; cmake --version
echo -e "\n pkg-config ? \c"; which pkg-config; pkg-config --version
echo -e "\n mpiifort ? \c"; which mpiifort; mpiifort --version
echo -e "\n mpirun ? \c"; which mpirun; mpirun --version
echo -e "\nIntel MKL library ? MKLROOT=$MKLROOT"; ls -l $MKLROOT


#SIESTA=/lustre/home/user/m/milias/work/software/siesta/downloaded_package/siesta-5.4.1
SIESTA=/lustre/home/user/m/milias/work/software/siesta/git_cloned/siesta_dev
BUILD=build_intelmpi_elpa

if [ -d "$BUILD" ]; then
  echo -e "\nDirectory '$BUILD' exists. Removing it..."
  rm -rf "$BUILD"
else
  echo -e "\nDirectory '$BUILD' does not exist - will be created by CMake."
fi


cd $SIESTA
echo -e "\nI am in the directory $SIESTA :\c";pwd

#cmake -S. -B$BUILD -DCMAKE_INSTALL_PREFIX=/lustre/home/user/m/milias/work/software/siesta/downloaded_package  -DSIESTA_WITH_MPI=ON -DSIESTA_WITH_ELPA=ON  -DSCALAPACK_LIBRARY="/cvmfs/hybrilit.jinr.ru/sw/slc7_x86-64/intel/oneapi/mkl/latest/lib/intel64/libmkl_scalapack_lp64.so;/cvmfs/hybrilit.jinr.ru/sw/slc7_x86-64/intel/oneapi/mkl/latest/lib/intel64/libmkl_blacs_intelmpi_lp64.so" -DFLOOK_ROOT=/lustre/home/user/m/milias/work/software/siesta/git_cloned/siesta_dev/External/Lua-Engine/flook

cmake -S. -B$BUILD -DCMAKE_INSTALL_PREFIX=/lustre/home/user/m/milias/work/software/siesta/downloaded_package  -DSIESTA_WITH_MPI=ON -DSIESTA_WITH_ELPA=ON  -DSCALAPACK_LIBRARY="/cvmfs/hybrilit.jinr.ru/sw/slc7_x86-64/intel/oneapi/mkl/latest/lib/intel64/libmkl_scalapack_lp64.so;/cvmfs/hybrilit.jinr.ru/sw/slc7_x86-64/intel/oneapi/mkl/latest/lib/intel64/libmkl_blacs_intelmpi_lp64.so" -DSIESTA_WITH_FLOOK=OFF

cd $BUILD
echo -e "\nI am in the directory $SIESTA/$BUILD :";pwd
ls -lt

exit
